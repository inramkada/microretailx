<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="referrer" content="no-referrer">
  <meta http-equiv="Permissions-Policy"
        content="geolocation=(), microphone=(), camera=(), payment=(), usb=()">
  <title>microretailX</title>

  <link rel="stylesheet" href="assets/app.css">
  <link rel="stylesheet" href="assets/legal-terms.css">

  <style>
    /* CANVAS BACKGROUND */
    #canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      display: block;
      pointer-events: none;
    }

    /* UI LAYERS */
    .ui-layer, .menu, .hero, .terms-wrap {
      position: relative;
      z-index: 2;
    }

    /* FOOTER */
    body {
      min-height: 100vh;
    }

    .footer-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 3;
    }

    .page-content {
      padding-bottom: 72px;
    }

    /* CONSENT LOCK - Bloquea interacción hasta decisión */
    html.consent-locked,
    body.consent-locked {
      overflow: hidden !important;
      height: 100vh;
    }

    body.consent-locked .footer-links a {
      pointer-events: none;
      opacity: 0.55;
    }

    body.consent-locked #backToTop {
      pointer-events: none;
      opacity: 0.55;
    }

    /* Capa de bloqueo visual */
    #consentLock {
      position: fixed;
      inset: 0;
      z-index: 998;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(3px);
      pointer-events: all;
    }

    html.consent-decided #consentLock {
      display: none;
    }

    /* MRX CONSENT UI - Mayor z-index que el lock */
    #mrxConsentUI {
      z-index: 999;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>

  <!-- TOP BAR -->
  <div class="ui-layer top-bar">
    <div class="menu">
      <div class="menu-dot"
           id="menuToggle"
           role="button"
           tabindex="0"
           aria-label="Open menu"
           aria-expanded="false"
           aria-controls="menuDropdown"></div>

      <div class="menu-dropdown" id="menuDropdown" role="menu" aria-hidden="true">
        <a href="javascript:void(0)" class="locations-link" id="verticalsLink"
           role="menuitem" aria-haspopup="true" aria-expanded="false">VERTICALS</a>
        <a href="/contact.html" id="contactLink" role="menuitem">CONTACT</a>
      </div>

      <div class="menu-dropdown-sub" id="verticalsSubmenu" aria-hidden="true">
        <div class="submenu-group">
          <div class="submenu-label">BIOTECH</div>
          <a class="submenu-link" href="https://www.microlabsx.com"
             target="_blank" rel="noopener">microlabsX</a>
          <div class="submenu-label">CREATIVE STUDIO</div>
          <a class="submenu-link" href="https://www.microstudiox.com"
             target="_blank" rel="noopener">microstudioX</a>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="ui-layer footer-bar">
    <div class="footer-links">
      <a class="legal-link" data-legal-link="terms" href="legal/terms.html">Terms</a>
      <a class="legal-link" data-legal-link="privacy" href="legal/privacy.html">Privacy</a>
      <a class="legal-link" data-legal-link="cookies" href="legal/cookies.html">Cookies</a>
      <a class="legal-link" data-legal-link="prefs" href="#" id="cookiePreferencesLink">Cookie Preferences</a>
      <a class="legal-link" data-legal-link="legal" href="legal/legal.html">Legal</a>
    </div>

    <div class="copyright">
      © 2023-2026 MICRORETAILX LLC — ALL RIGHTS RESERVED
    </div>
  </div>

  <div class="privacy-toast" id="privacyToast" role="status" aria-live="polite"></div>

  <!-- Legacy app.js & legal-terms.js -->
  <script src="assets/legal-terms.js" defer></script>
  <script src="assets/app.js" defer></script>

  <!-- NUEVO SISTEMA MODULAR DE CONSENT -->
  <script type="module">
    import { applyInitialLock, onDecided, clearConsent } from './assets/consent-core.js';
    import { maybeMountConsentUI } from './assets/consent-ui.js';
    import { init as initParticles } from './assets/fondo-particulas-inicio.js';

    // 1. Aplicar lock inicial basado en localStorage
    applyInitialLock();

    // 2. Montar UI de consent si no hay decisión
    maybeMountConsentUI();

    // 3. Iniciar background de partículas
    const destroyParticles = initParticles('canvas');

    // 4. Escuchar decisión de consent para unlock
    onDecided((consent) => {
      console.log('[MRX] Consent decided:', consent);
      // El unlock ya se aplica automáticamente en consent-core.js via setHtmlLock(false)
    });

    // 5. Link para reabrir preferencias
    const prefLink = document.getElementById('cookiePreferencesLink');
    if (prefLink) {
      prefLink.addEventListener('click', (e) => {
        e.preventDefault();
        // Reimportar y montar UI
        import('./assets/consent-ui.js').then(({ mountConsentUI }) => {
          mountConsentUI();
        });
      });
    }

    // 6. Cleanup on page unload (opcional)
    window.addEventListener('beforeunload', () => {
      if (destroyParticles) destroyParticles();
    });
  </script>
</body>
</html>
