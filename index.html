<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>microretailX</title>

  <!-- IMPORTANT:
       If you already set CSP as a Cloudflare RESPONSE HEADER, remove this meta CSP to avoid conflicts.
       (Cloudflare header + meta CSP can combine and break canvas/scripts.) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 font-src 'self';
                 connect-src 'self';
                 base-uri 'self';
                 frame-ancestors 'none';
                 form-action 'self'">

  <meta name="referrer" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=()">

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --glass: rgba(0,0,0,.92);
      --hair: rgba(255,255,255,.12);
      --cyan: rgba(0,234,255,.95);
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--fg);
      overflow:hidden;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    canvas{ display:block; width:100vw; height:100vh; }

    /* ===== UI ===== */
    .ui-layer{ position:absolute; z-index:10; color:#fff; user-select:none; }

    .top-bar{
      top:0; right:0; width:100%;
      background: var(--glass);
      display:flex; justify-content:flex-end;
      padding:12px 26px; box-sizing:border-box;
      border-bottom: 1px solid var(--hair);
      backdrop-filter: blur(10px);
    }

    .menu-dot{
      width:15px; height:15px; border-radius:50%;
      background:#fff; opacity:.85;
    }

    .footer-bar{
      bottom:0; left:0; width:100%;
      background: var(--glass);
      display:flex; flex-direction:column; align-items:center;
      padding:10px 0 8px; box-sizing:border-box;
      border-top: 1px solid var(--hair);
      backdrop-filter: blur(10px);
    }

    .footer-links{
      display:flex; flex-wrap:wrap; justify-content:center; align-items:center;
      font-size:15px; margin-bottom:6px; line-height:1.9;
    }
    .footer-links a{
      color:#fff; text-decoration:none;
      margin:4px 0; padding:0 10px; opacity:.85; cursor:pointer;
      position:relative;
    }
    .footer-links a:hover{ opacity:1; text-decoration:underline; }
    .footer-links a:not(:last-child)::after{
      content:"·"; position:absolute; right:-2px; top:50%;
      transform:translateY(-52%); opacity:.38;
    }

    .copyright{
      font-size:9px; letter-spacing:1px; opacity:.45;
      text-align:center; padding:0 14px; line-height:1.35;
    }

    @media (max-width: 600px){
      .menu-dot{ width:12px; height:12px; }
      .footer-links{ font-size:13px; padding:0 12px; }
      .footer-links a{ padding:0 10px; }
      .footer-links a:not(:last-child)::after{ right:-3px; }
      .copyright{ font-size:8px; }
    }

    /* ===== Consent lock: blocks site interaction until decision ===== */
    body.consent-locked .ui-layer,
    body.consent-locked canvas{
      pointer-events:none !important;
      filter: grayscale(1) brightness(0.72) contrast(1.08);
      opacity: 0.92;
      transition: filter 0.8s ease, opacity 0.8s ease;
    }

    body.consent-waking .ui-layer,
    body.consent-waking canvas{
      filter:none; opacity:1;
    }

    body.consent-locked #consentBanner,
    body.consent-locked #consentModalBackdrop{
      pointer-events:auto !important;
      filter:none !important;
      opacity:1 !important;
    }

    /* ===== Consent banner ===== */
    .consent-banner{
      position:fixed; left:0; right:0; bottom:0;
      z-index:9999;
      background: rgba(0,0,0,.92);
      border-top:1px solid rgba(255,255,255,.15);
      box-shadow: 0 -10px 34px rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      padding:14px 18px; box-sizing:border-box;
      display:none;
    }
    body.consent-locked .consent-banner{
      left:50%; right:auto; bottom:auto; top:50%;
      transform: translate(-50%,-50%);
      width: min(920px, calc(100% - 36px));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 40px rgba(255,255,255,.10), 0 0 100px rgba(255,255,255,.04);
    }
    .consent-banner.open{ display:block; }

    .consent-row{ display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .consent-text{ color:#e8ffff; opacity:.92; font-size:13px; line-height:1.4; max-width:860px; }
    .consent-text a{ color:#fff; text-decoration:none; opacity:.95; }
    .consent-text a:hover{ text-decoration:underline; opacity:1; }

    .consent-actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .consent-btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding:9px 12px; border-radius:10px;
      cursor:pointer;
      font-family: inherit;
      letter-spacing:.5px; font-size:12px;
      opacity:.95;
    }
    .consent-btn:hover{ opacity:1; box-shadow:0 0 18px rgba(255,255,255,.12); }
    .consent-btn.primary{
      border-color: rgba(255,255,255,.42);
      background: rgba(255,255,255,.12);
      box-shadow:0 0 22px rgba(255,255,255,.18);
    }

    /* ===== Consent modal ===== */
    .consent-modal-backdrop{
      position:fixed; inset:0; z-index:10000;
      background: rgba(0,0,0,.74);
      display:none;
      align-items:center; justify-content:center;
      padding:18px; box-sizing:border-box;
    }
    .consent-modal-backdrop.open{ display:flex; }

    .consent-modal{
      width:min(720px,100%);
      border-radius:16px;
      background: rgba(0,8,18,.94);
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 40px rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .consent-modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .consent-modal-title{ font-size:13px; letter-spacing:1px; color:#fff; opacity:.95; }
    .consent-modal-close{
      width:30px; height:30px; border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff; cursor:pointer; font-family: inherit; font-size:14px; opacity:.9;
    }
    .consent-modal-close:hover{ opacity:1; }
    .consent-modal-body{
      padding:14px 16px 8px;
      color:#e8ffff; font-size:13px; line-height:1.45; opacity:.93;
    }
    .consent-cats{ display:grid; gap:10px; margin-top:10px; }
    .consent-cat{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(255,255,255,.03);
    }
    .consent-cat strong{ display:block; font-size:12px; letter-spacing:.7px; color:#fff; opacity:.95; margin-bottom:4px; }
    .consent-cat p{ margin:0; font-size:12px; opacity:.86; max-width:520px; }

    .toggle{
      position:relative; width:44px; height:24px; flex:0 0 auto;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.07);
      cursor:pointer; margin-top:2px;
    }
    .toggle::after{
      content:""; position:absolute; top:2px; left:2px;
      width:18px; height:18px; border-radius:50%;
      background: rgba(255,255,255,.92);
      transition: transform .18s ease;
    }
    .toggle.on{
      border-color: rgba(255,255,255,.35);
      background: rgba(255,255,255,.14);
      box-shadow:0 0 18px rgba(255,255,255,.10);
    }
    .toggle.on::after{ transform: translateX(20px); }
    .toggle.locked{ opacity:.6; cursor:not-allowed; }

    .consent-modal-footer{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      padding:12px 16px 14px;
      border-top:1px solid rgba(255,255,255,.12);
    }

    @media (prefers-reduced-motion: reduce){
      canvas{ opacity:1 !important; filter:none !important; }
      *{ transition:none !important; animation:none !important; }
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>

  <div class="ui-layer top-bar">
    <div class="menu-dot" aria-hidden="true"></div>
  </div>

  <div class="ui-layer footer-bar">
    <div class="footer-links">
      <a href="terms.html" id="linkTerms">Terms</a>
      <a href="privacy.html" id="linkPrivacy">Privacy</a>
      <a href="cookies.html" id="linkCookies">Cookies</a>
      <a href="javascript:void(0)" id="cookiePreferencesLink">Cookie Preferences</a>
      <a href="legal.html" id="linkLegal">Legal</a>
    </div>
    <div class="copyright">© 2023–2026 MICRORETAILX LLC — ALL RIGHTS RESERVED</div>
  </div>

  <!-- Consent Banner -->
  <div class="consent-banner" id="consentBanner" aria-live="polite">
    <div class="consent-row">
      <div class="consent-text">
        We use strictly necessary technologies to operate this site and store your preferences locally in your browser.
        Optional categories (Analytics / Marketing) are not active and would only apply if implemented in the future and you explicitly enable them.
        You can review or change your choice anytime via <a href="javascript:void(0)" id="cookiePreferencesInline">Cookie Preferences</a>.
      </div>
      <div class="consent-actions">
        <button class="consent-btn" id="consentReject">Reject</button>
        <button class="consent-btn" id="consentManage">Preferences</button>
        <button class="consent-btn primary" id="consentAccept">Accept</button>
      </div>
    </div>
  </div>

  <!-- Consent Modal -->
  <div class="consent-modal-backdrop" id="consentModalBackdrop" aria-hidden="true">
    <div class="consent-modal" role="dialog" aria-modal="true" aria-label="Cookie Preferences">
      <div class="consent-modal-header">
        <div class="consent-modal-title">COOKIE PREFERENCES</div>
        <button class="consent-modal-close" id="consentModalClose" aria-label="Close">×</button>
      </div>
      <div class="consent-modal-body">
        Choose which optional categories you would allow if such technologies are implemented in the future.
        Strictly necessary technologies are always enabled and do not require consent.
        <div class="consent-cats">
          <div class="consent-cat">
            <div>
              <strong>Necessary</strong>
              <p>Required for basic functionality, security and page delivery. Always on.</p>
            </div>
            <div class="toggle on locked" aria-label="Necessary cookies (always on)"></div>
          </div>

          <div class="consent-cat">
            <div>
              <strong>Analytics (future use)</strong>
              <p>No analytics technologies are currently active. If implemented, they would only load after your consent.</p>
            </div>
            <div class="toggle" id="toggleAnalytics" role="switch" aria-checked="false" tabindex="0" aria-label="Analytics cookies"></div>
          </div>

          <div class="consent-cat">
            <div>
              <strong>Marketing (future use)</strong>
              <p>No marketing/tracking technologies are currently active. If implemented, they would only load after your consent.</p>
            </div>
            <div class="toggle" id="toggleMarketing" role="switch" aria-checked="false" tabindex="0" aria-label="Marketing cookies"></div>
          </div>
        </div>
      </div>
      <div class="consent-modal-footer">
        <button class="consent-btn" id="consentSave">Save</button>
        <button class="consent-btn primary" id="consentAcceptAll">Accept All</button>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    /* ===========================
       CONSENT (hard lock)
    ============================ */
    const CONSENT_KEY = "mrxx_consent_v1";
    const consentBanner = document.getElementById("consentBanner");
    const consentModalBackdrop = document.getElementById("consentModalBackdrop");

    const cookiePreferencesLink = document.getElementById("cookiePreferencesLink");
    const cookiePreferencesInline = document.getElementById("cookiePreferencesInline");

    const consentReject = document.getElementById("consentReject");
    const consentManage = document.getElementById("consentManage");
    const consentAccept = document.getElementById("consentAccept");

    const consentModalClose = document.getElementById("consentModalClose");
    const consentSave = document.getElementById("consentSave");
    const consentAcceptAll = document.getElementById("consentAcceptAll");

    const toggleAnalytics = document.getElementById("toggleAnalytics");
    const toggleMarketing = document.getElementById("toggleMarketing");

    function persistConsent(state){ localStorage.setItem(CONSENT_KEY, JSON.stringify(state)); }
    function loadConsent(){
      const ls = localStorage.getItem(CONSENT_KEY);
      if (!ls) return null;
      try { return JSON.parse(ls); } catch { return null; }
    }

    function lockSite(){
      document.body.classList.add("consent-locked");
      document.documentElement.style.overflow = "hidden";
    }
    function wakeSite(){
      document.body.classList.remove("consent-locked");
      document.documentElement.style.overflow = "";
      document.body.classList.add("consent-waking");
      setTimeout(() => document.body.classList.remove("consent-waking"), 900);
    }

    function setToggle(el, on){
      el.classList.toggle("on", !!on);
      el.setAttribute("aria-checked", String(!!on));
    }
    function toggleSwitch(el){ setToggle(el, !el.classList.contains("on")); }
    function handleSwitchKey(el, e){
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleSwitch(el); }
    }

    function openConsentPanel(){
      const current = loadConsent() || { necessary:true, analytics:false, marketing:false, ts:Date.now(), decision:null };
      setToggle(toggleAnalytics, !!current.analytics);
      setToggle(toggleMarketing, !!current.marketing);
      consentModalBackdrop.classList.add("open");
      consentModalBackdrop.setAttribute("aria-hidden", "false");
    }
    function closeConsentPanel(){
      consentModalBackdrop.classList.remove("open");
      consentModalBackdrop.setAttribute("aria-hidden", "true");
    }
    function showBanner(){ consentBanner.classList.add("open"); }
    function hideBanner(){ consentBanner.classList.remove("open"); }

    function finalize(consent){
      persistConsent(consent);
      hideBanner();
      closeConsentPanel();
      wakeSite();
    }

    function setAllConsent(granted){
      finalize({
        necessary: true,
        analytics: !!granted,
        marketing: !!granted,
        ts: Date.now(),
        decision: granted ? "accepted" : "rejected"
      });
    }

    function saveFromPanel(){
      const analytics = toggleAnalytics.classList.contains("on");
      const marketing = toggleMarketing.classList.contains("on");
      finalize({
        necessary: true,
        analytics, marketing,
        ts: Date.now(),
        decision: (analytics || marketing) ? "accepted" : "rejected"
      });
    }

    cookiePreferencesLink.addEventListener("click", (e)=>{ e.preventDefault(); openConsentPanel(); });
    cookiePreferencesInline.addEventListener("click", (e)=>{ e.preventDefault(); openConsentPanel(); });

    consentManage.addEventListener("click", ()=> openConsentPanel());
    consentReject.addEventListener("click", ()=> setAllConsent(false));
    consentAccept.addEventListener("click", ()=> setAllConsent(true));

    consentModalClose.addEventListener("click", ()=> closeConsentPanel());
    consentSave.addEventListener("click", ()=> saveFromPanel());
    consentAcceptAll.addEventListener("click", ()=> setAllConsent(true));

    consentModalBackdrop.addEventListener("click", (e)=>{ if (e.target === consentModalBackdrop) closeConsentPanel(); });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeConsentPanel(); });

    toggleAnalytics.addEventListener("click", ()=> toggleSwitch(toggleAnalytics));
    toggleMarketing.addEventListener("click", ()=> toggleSwitch(toggleMarketing));
    toggleAnalytics.addEventListener("keydown", (e)=> handleSwitchKey(toggleAnalytics, e));
    toggleMarketing.addEventListener("keydown", (e)=> handleSwitchKey(toggleMarketing, e));

    const existing = loadConsent();
    if (existing && existing.decision) {
      wakeSite();
    } else {
      lockSite();
      showBanner();
    }

    /* ===========================
       BACKGROUND: X pulse + flow-to-X particles
       (No O(n^2). Safe for laptops/phones.)
    ============================ */

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d", { alpha: false });

    const UA = navigator.userAgent || "";
    const IS_IOS = /iPhone|iPad|iPod/i.test(UA) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
    const IS_MOBILE = /Mobi|Android|iPhone|iPad/i.test(UA);
    const REDUCED = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    // FPS cap for iOS/mobile (prevents overheating)
    const TARGET_FPS = (IS_IOS || IS_MOBILE) ? 30 : 60;
    let lastFrameT = 0;

    // Canvas sizing
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;

    function resize(){
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);

    // Helpers
    const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
    const lerp = (a,b,t)=> a + (b-a)*t;
    const easeInOutCubic = (t)=> t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2;
    const smoothPulse = (t)=> 0.5 - 0.5*Math.cos(Math.PI * clamp(t,0,1));

    function drawLines(alpha){
      ctx.save();
      ctx.strokeStyle = `rgba(0,234,255,${alpha})`;
      ctx.lineWidth = 1.6;
      ctx.beginPath();
      ctx.moveTo(0, 0); ctx.lineTo(width, height);
      ctx.moveTo(width, 0); ctx.lineTo(0, height);
      ctx.stroke();

      ctx.strokeStyle = `rgba(0,234,255,${alpha*0.52})`;
      ctx.lineWidth = 3.0;
      ctx.beginPath();
      ctx.moveTo(0, 0); ctx.lineTo(width, height);
      ctx.moveTo(width, 0); ctx.lineTo(0, height);
      ctx.stroke();
      ctx.restore();
    }

    function glowDot(x, y, r, a, rgb){
      if (a <= 0) return;
      const c = rgb || { r:0, g:234, b:255 };
      const boost = IS_IOS ? 1.35 : 1.0;
      const aa = Math.min(1, a * boost);

      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      const g = ctx.createRadialGradient(x, y, 0, x, y, r);
      g.addColorStop(0, `rgba(${c.r},${c.g},${c.b},${aa})`);
      g.addColorStop(0.35, `rgba(${c.r},${c.g},${c.b},${aa*0.35})`);
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    // X pulse timing
    let xPhaseT = 0;
    let xLastT = performance.now();

    const X_PHASE_IN   = 2.6;
    const X_PHASE_HOLD = 1.1;
    const X_PHASE_OUT  = 2.1;
    const X_PHASE_REST = 0.55;
    const X_CYCLE = X_PHASE_IN + X_PHASE_HOLD + X_PHASE_OUT + X_PHASE_REST;

    const DOT_RGB = { r:0, g:234, b:255 };
    const PULSE_RGB = { r:255, g:35, b:90 };

    function renderXPulse(now){
      const dt = Math.min(0.05, (now - xLastT) / 1000);
      xLastT = now;
      xPhaseT = (xPhaseT + dt) % X_CYCLE;

      const cx = width / 2;
      const cy = height / 2;

      const tIn   = clamp(xPhaseT / X_PHASE_IN, 0, 1);
      const tHold = clamp((xPhaseT - X_PHASE_IN) / X_PHASE_HOLD, 0, 1);
      const tOut  = clamp((xPhaseT - X_PHASE_IN - X_PHASE_HOLD) / X_PHASE_OUT, 0, 1);

      const inActive   = xPhaseT < X_PHASE_IN;
      const holdActive = xPhaseT >= X_PHASE_IN && xPhaseT < X_PHASE_IN + X_PHASE_HOLD;
      const outActive  = xPhaseT >= X_PHASE_IN + X_PHASE_HOLD && xPhaseT < X_PHASE_IN + X_PHASE_HOLD + X_PHASE_OUT;

      const travelIn  = easeInOutCubic(tIn);
      const travelOut = easeInOutCubic(tOut);
      const glowUp = smoothPulse(tHold);
      const fadeOut = 1 - smoothPulse(tOut);

      // background X lines
      const baseA = 0.055;
      let lineA = baseA;
      if (inActive)   lineA = baseA + 0.07 * smoothPulse(tIn);
      if (holdActive) lineA = baseA + 0.16 * glowUp;
      if (outActive)  lineA = baseA + 0.12 * fadeOut;

      drawLines(lineA);

      const origins = [
        {x:0, y:0},
        {x:width, y:0},
        {x:0, y:height},
        {x:width, y:height}
      ];

      function posFromOrigin(o, progress){
        return { x: lerp(o.x, cx, progress), y: lerp(o.y, cy, progress) };
      }
      function posReturnToOrigin(o, progress){
        return { x: lerp(cx, o.x, progress), y: lerp(cy, o.y, progress) };
      }

      const headR = IS_MOBILE ? 54 : 70;
      const tailSteps = IS_MOBILE ? 10 : 14;
      const tailSpan = 0.10;

      function drawTrail(posFn, prog, alphaScale){
        for (let oi = 0; oi < origins.length; oi++){
          const o = origins[oi];
          const head = posFn(o, prog);

          for (let i = 0; i < tailSteps; i++){
            const k = i / tailSteps;
            const tt = clamp(prog - k*tailSpan, 0, 1);
            const e = easeInOutCubic(tt);
            const p = posFn(o, e);
            const fade = (1 - k);
            glowDot(p.x, p.y, (IS_MOBILE ? 26 : 34) * fade, alphaScale * (0.07 * fade), DOT_RGB);
          }
          glowDot(head.x, head.y, headR, alphaScale * 0.22, DOT_RGB);
        }
      }

      if (REDUCED) return;

      if (inActive){
        drawTrail(posFromOrigin, travelIn, 1);
      } else if (holdActive){
        const centerBurst = 0.22 + 0.75 * glowUp;
        glowDot(cx, cy, IS_MOBILE ? 96 : 120, centerBurst * 0.20, DOT_RGB);

        if (glowUp > 0.55){
          const pulseA = (IS_IOS ? 0.62 : 0.48) * centerBurst;
          glowDot(cx, cy, (IS_MOBILE ? 122 : 145) + 35*glowUp, pulseA, PULSE_RGB);
          glowDot(cx, cy, (IS_MOBILE ? 78 : 92) + 18*glowUp, pulseA * 0.55, PULSE_RGB);
        }

        glowDot(cx, cy, IS_MOBILE ? 36 : 44, centerBurst * 0.65, DOT_RGB);
      } else if (outActive){
        const a = Math.max(0, 0.9 * fadeOut);
        drawTrail(posReturnToOrigin, travelOut, a);
        glowDot(cx, cy, IS_MOBILE ? 62 : 78, (0.10 + 0.20 * fadeOut) * 0.35, DOT_RGB);
      } else {
        glowDot(cx, cy, IS_MOBILE ? 56 : 64, 0.02, DOT_RGB);
      }
    }

    // ===== Flow-to-X particles (cheap vector field) =====
    const CORES = navigator.hardwareConcurrency || 4;

    const PCOUNT = REDUCED
      ? (IS_MOBILE ? 120 : 220)
      : (IS_MOBILE ? 240 : Math.min(1100, CORES * 240));

    const particles = new Array(PCOUNT).fill(0).map(() => ({
      x: Math.random() * width,
      y: Math.random() * height,
      vx: (Math.random() - 0.5) * 0.45,
      vy: (Math.random() - 0.5) * 0.45,
      seed: Math.random() * 1000
    }));

    const mouse = { x:-9999, y:-9999 };
    window.addEventListener("mousemove", (e)=>{ mouse.x = e.clientX; mouse.y = e.clientY; }, { passive:true });
    window.addEventListener("touchmove", (e)=>{
      if (!e.touches || !e.touches[0]) return;
      mouse.x = e.touches[0].clientX;
      mouse.y = e.touches[0].clientY;
    }, { passive:true });

    function distToDiag1(x, y){ // y = (H/W)*x
      const m = height / width;
      return Math.abs(y - m * x);
    }
    function distToDiag2(x, y){ // y = H - (H/W)*x
      const m = height / width;
      return Math.abs(y - (height - m * x));
    }

    function projectToDiag1(x, y){
      const m = height / width;
      const inv = 1 / Math.sqrt(1 + m*m);
      const ux = inv, uy = m * inv;
      const dot = x*ux + y*uy;
      return { x: dot*ux, y: dot*uy };
    }
    function projectToDiag2(x, y){
      const m = height / width;
      const yy = y - height;
      const inv = 1 / Math.sqrt(1 + m*m);
      const ux = inv, uy = -m * inv;
      const dot = x*ux + yy*uy;
      return { x: dot*ux, y: dot*uy + height };
    }

    function updateAndDrawFlow(now){
      const ATTRACT = IS_MOBILE ? 0.055 : 0.07;    // pull to X
      const SWIRL   = IS_MOBILE ? 0.020 : 0.028;   // slide along X
      const DAMP    = 0.985;                       // friction
      const JITTER  = REDUCED ? 0 : (IS_MOBILE ? 0.006 : 0.009);
      const NEAR    = IS_MOBILE ? 22 : 30;

      const repelR2 = (IS_MOBILE ? 70 : 90) ** 2;

      for (let i=0;i<particles.length;i++){
        const p = particles[i];

        // pick nearest diagonal
        const d1 = distToDiag1(p.x, p.y);
        const d2 = distToDiag2(p.x, p.y);
        const use1 = d1 <= d2;
        const target = use1 ? projectToDiag1(p.x, p.y) : projectToDiag2(p.x, p.y);

        // unit vector to target
        let dx = target.x - p.x;
        let dy = target.y - p.y;
        const dd = dx*dx + dy*dy + 1e-6;
        const invd = 1 / Math.sqrt(dd);
        dx *= invd; dy *= invd;

        const dist = Math.sqrt(dd);
        const near = dist < NEAR ? (1 - dist/NEAR) : 0;

        // tangent (perpendicular) for swirl
        const tx = -dy, ty = dx;
        const sgn = (Math.sin(p.seed + now*0.0006) > 0 ? 1 : -1);

        p.vx += dx * ATTRACT;
        p.vy += dy * ATTRACT;

        p.vx += tx * SWIRL * near * sgn;
        p.vy += ty * SWIRL * near * sgn;

        // mouse repulsion (cheap)
        const mx = p.x - mouse.x;
        const my = p.y - mouse.y;
        const md2 = mx*mx + my*my;
        if (md2 < repelR2 && md2 > 0.0001){
          const md = Math.sqrt(md2);
          const f = (Math.sqrt(repelR2) - md) * (IS_MOBILE ? 0.0008 : 0.0010);
          p.vx += (mx / md) * f * 60;
          p.vy += (my / md) * f * 60;
        }

        // micro noise
        if (JITTER){
          p.vx += Math.sin(now*0.0012 + p.seed) * JITTER;
          p.vy += Math.cos(now*0.0011 + p.seed) * JITTER;
        }

        // integrate
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= DAMP;
        p.vy *= DAMP;

        // wrap edges
        if (p.x < 0) p.x += width;
        if (p.x > width) p.x -= width;
        if (p.y < 0) p.y += height;
        if (p.y > height) p.y -= height;

        // glow (stronger near X)
        const a = 0.045 + 0.11 * near;
        glowDot(p.x, p.y, (IS_MOBILE ? 9 : 10) + (IS_MOBILE ? 12 : 14) * near, a, DOT_RGB);
      }
    }

    function frame(now){
      // FPS cap on iOS/mobile
      if (TARGET_FPS !== 60){
        const minDt = 1000 / TARGET_FPS;
        if (now - lastFrameT < minDt){
          requestAnimationFrame(frame);
          return;
        }
        lastFrameT = now;
      }

      // clear
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, width, height);

      // X pulse + flow
      renderXPulse(now);
      updateAndDrawFlow(now);

      requestAnimationFrame(frame);
    }

    requestAnimationFrame(frame);
  </script>
</body>
</html>
