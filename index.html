<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>microretailX — Life</title>

  <!-- If you set CSP in Cloudflare, REMOVE this meta CSP to avoid conflicts -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 font-src 'self';
                 connect-src 'self';
                 base-uri 'self';
                 frame-ancestors 'none';
                 form-action 'self'">

  <meta name="referrer" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=()">

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #fff;
    }

    canvas { display:block; width:100vw; height:100vh; }

    .ui {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 10;
    }

    .top {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.78);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
    }

    .brand {
      letter-spacing: 3px;
      font-size: 12px;
      opacity: .9;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .status {
      font-size: 11px;
      letter-spacing: 1px;
      opacity: .65;
      text-align: right;
      line-height: 1.35;
      white-space: nowrap;
    }

    .footer {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      padding: 10px 18px 12px;
      display:flex;
      justify-content: space-between;
      align-items: flex-end;
      background: rgba(0,0,0,0.78);
      border-top: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
      gap: 14px;
    }

    .help {
      font-size: 10px;
      letter-spacing: 1px;
      opacity: .55;
      line-height: 1.5;
    }

    .pill {
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      padding: 8px 10px;
      border-radius: 14px;
      box-shadow: 0 0 20px rgba(255,255,255,0.06);
    }

    .btn {
      pointer-events: auto;
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #fff;
      padding: 7px 10px;
      border-radius: 12px;
      font-family: inherit;
      font-size: 11px;
      letter-spacing: .6px;
      cursor: pointer;
      opacity: .92;
    }
    .btn:hover { opacity: 1; box-shadow: 0 0 18px rgba(255,255,255,0.10); }

    .kbd {
      display:inline-block;
      padding: 1px 6px;
      border: 1px solid rgba(255,255,255,0.18);
      border-bottom-color: rgba(255,255,255,0.28);
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      opacity: .9;
      margin: 0 2px;
    }

    @media (max-width: 720px){
      .footer { flex-direction: column; align-items: stretch; }
      .pill { justify-content: space-between; }
      .status { display:none; }
    }

    @media (prefers-reduced-motion: reduce){
      .help { opacity: .8; }
    }
  </style>
</head>

<body>
  <canvas id="c"></canvas>

  <div class="ui">
    <div class="top">
      <div class="brand">microretailX / LIFE</div>
      <div class="status" id="status">
        RUNNING · speed: 12/s<br/>
        cells: —
      </div>
    </div>

    <div class="footer">
      <div class="help">
        Paint: click/drag · Toggle pause: <span class="kbd">Space</span> · Random: <span class="kbd">R</span> · Clear: <span class="kbd">C</span><br/>
        Speed: <span class="kbd">+</span>/<span class="kbd">-</span> · Brush: <span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span>
      </div>

      <div class="pill">
        <button class="btn" id="btnPause">Pause</button>
        <button class="btn" id="btnRandom">Random</button>
        <button class="btn" id="btnClear">Clear</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha: false });

  const statusEl = document.getElementById("status");
  const btnPause = document.getElementById("btnPause");
  const btnRandom = document.getElementById("btnRandom");
  const btnClear  = document.getElementById("btnClear");

  const REDUCED = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  const DPR_CAP = 2;
  let dpr = Math.min(DPR_CAP, window.devicePixelRatio || 1);

  // Visual tuning
  const BG = "#000";
  const GRID_FADE = 0.06;
  const GLOW_A = 0.28;
  const CELL_A = 0.9;

  // Simulation
  let running = true;
  let stepsPerSecond = REDUCED ? 6 : 12;
  let brush = 1;

  // Grid sizing (auto)
  let cellSize = 8;          // px (logical)
  let cols = 0, rows = 0;    // grid dims
  let a = null, b = null;    // double buffer Uint8Array

  // Pointer
  const pointer = { down:false, x:-1, y:-1 };

  function resize() {
    dpr = Math.min(DPR_CAP, window.devicePixelRatio || 1);
    const W = Math.floor(window.innerWidth);
    const H = Math.floor(window.innerHeight);

    canvas.width  = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
    canvas.style.width = W + "px";
    canvas.style.height = H + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // Choose cellSize based on viewport
    const minDim = Math.min(W, H);
    cellSize = minDim < 520 ? 9 : 8;
    if (minDim < 380) cellSize = 10;

    const newCols = Math.max(40, Math.floor(W / cellSize));
    const newRows = Math.max(30, Math.floor(H / cellSize));

    // Reinit buffers
    cols = newCols;
    rows = newRows;
    a = new Uint8Array(cols * rows);
    b = new Uint8Array(cols * rows);

    seedNice();
    draw(true);
  }

  function idx(x, y) { return y * cols + x; }

  function seedNice() {
    // balanced seed, with a few clusters + noise
    a.fill(0);
    const noise = 0.09;
    for (let i = 0; i < a.length; i++) a[i] = (Math.random() < noise) ? 1 : 0;

    // a couple of denser blobs
    for (let k = 0; k < 4; k++) {
      const cx = (Math.random() * cols) | 0;
      const cy = (Math.random() * rows) | 0;
      const r = 6 + ((Math.random() * 10) | 0);
      for (let y = -r; y <= r; y++) for (let x = -r; x <= r; x++) {
        const xx = cx + x, yy = cy + y;
        if (xx < 1 || yy < 1 || xx >= cols - 1 || yy >= rows - 1) continue;
        if (x*x + y*y <= r*r && Math.random() < 0.35) a[idx(xx, yy)] = 1;
      }
    }
  }

  function clear() {
    a.fill(0);
  }

  function randomize() {
    const p = 0.14;
    for (let i = 0; i < a.length; i++) a[i] = (Math.random() < p) ? 1 : 0;
  }

  function step() {
    // Conway: B3/S23
    // wrap edges (toroidal)
    const w = cols, h = rows;
    let alive = 0;

    for (let y = 0; y < h; y++) {
      const ym1 = (y - 1 + h) % h;
      const yp1 = (y + 1) % h;

      for (let x = 0; x < w; x++) {
        const xm1 = (x - 1 + w) % w;
        const xp1 = (x + 1) % w;

        const n =
          a[idx(xm1, ym1)] + a[idx(x, ym1)] + a[idx(xp1, ym1)] +
          a[idx(xm1, y)]                 +     a[idx(xp1, y)] +
          a[idx(xm1, yp1)] + a[idx(x, yp1)] + a[idx(xp1, yp1)];

        const here = a[idx(x, y)];
        const next = (here === 1)
          ? (n === 2 || n === 3 ? 1 : 0)
          : (n === 3 ? 1 : 0);

        b[idx(x, y)] = next;
        alive += next;
      }
    }

    // swap
    const tmp = a; a = b; b = tmp;
    return alive;
  }

  function draw(forceGrid=false) {
    const W = window.innerWidth, H = window.innerHeight;

    // background
    ctx.fillStyle = BG;
    ctx.fillRect(0, 0, W, H);

    // subtle diagonals (signature)
    ctx.save();
    ctx.strokeStyle = `rgba(0,255,255,${GRID_FADE})`;
    ctx.lineWidth = 1.4;
    ctx.beginPath();
    ctx.moveTo(0, 0); ctx.lineTo(W, H);
    ctx.moveTo(W, 0); ctx.lineTo(0, H);
    ctx.stroke();
    ctx.restore();

    // draw cells with glow
    ctx.save();
    ctx.globalCompositeOperation = "lighter";

    let alive = 0;
    for (let y = 0; y < rows; y++) {
      const py = y * cellSize;
      for (let x = 0; x < cols; x++) {
        if (!a[idx(x, y)]) continue;
        alive++;

        const px = x * cellSize;
        const cx = px + cellSize * 0.5;
        const cy = py + cellSize * 0.5;

        // glow
        const r = cellSize * 1.8;
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
        g.addColorStop(0, `rgba(0,234,255,${GLOW_A})`);
        g.addColorStop(0.35, `rgba(0,234,255,${GLOW_A * 0.35})`);
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fill();

        // core
        ctx.fillStyle = `rgba(255,255,255,${CELL_A})`;
        ctx.fillRect(px + 1, py + 1, Math.max(1, cellSize - 2), Math.max(1, cellSize - 2));
      }
    }
    ctx.restore();

    if (statusEl) {
      statusEl.textContent =
        `${running ? "RUNNING" : "PAUSED"} · speed: ${stepsPerSecond}/s\ncells: ${alive.toLocaleString()}`;
    }
  }

  function paintAt(clientX, clientY, val=1) {
    const x = Math.floor(clientX / cellSize);
    const y = Math.floor(clientY / cellSize);
    if (x < 0 || y < 0 || x >= cols || y >= rows) return;

    for (let yy = -brush; yy <= brush; yy++) for (let xx = -brush; xx <= brush; xx++) {
      const nx = x + xx, ny = y + yy;
      if (nx < 0 || ny < 0 || nx >= cols || ny >= rows) continue;
      if (xx*xx + yy*yy <= brush*brush) a[idx(nx, ny)] = val;
    }
  }

  // Input
  canvas.addEventListener("mousedown", (e) => {
    pointer.down = true;
    paintAt(e.clientX, e.clientY, 1);
    draw();
  });
  window.addEventListener("mouseup", () => { pointer.down = false; });

  window.addEventListener("mousemove", (e) => {
    if (!pointer.down) return;
    paintAt(e.clientX, e.clientY, 1);
    draw();
  }, { passive: true });

  canvas.addEventListener("touchstart", (e) => {
    pointer.down = true;
    const t = e.touches && e.touches[0];
    if (!t) return;
    paintAt(t.clientX, t.clientY, 1);
    draw();
  }, { passive: true });

  window.addEventListener("touchend", () => { pointer.down = false; }, { passive:true });
  window.addEventListener("touchmove", (e) => {
    if (!pointer.down) return;
    const t = e.touches && e.touches[0];
    if (!t) return;
    paintAt(t.clientX, t.clientY, 1);
    draw();
  }, { passive:true });

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if (e.key === " "){ e.preventDefault(); toggleRun(); }
    if (e.key === "r" || e.key === "R"){ randomize(); draw(); }
    if (e.key === "c" || e.key === "C"){ clear(); draw(); }
    if (e.key === "+" || e.key === "="){ stepsPerSecond = Math.min(60, stepsPerSecond + 2); }
    if (e.key === "-" || e.key === "_"){ stepsPerSecond = Math.max(1, stepsPerSecond - 2); }
    if (e.key === "1") brush = 1;
    if (e.key === "2") brush = 2;
    if (e.key === "3") brush = 3;
  });

  // UI buttons
  function toggleRun() {
    running = !running;
    btnPause.textContent = running ? "Pause" : "Run";
  }
  btnPause.addEventListener("click", toggleRun);
  btnRandom.addEventListener("click", () => { randomize(); draw(); });
  btnClear.addEventListener("click", () => { clear(); draw(); });

  // Timing loop
  let acc = 0;
  let last = performance.now();

  function loop(now) {
    const dt = Math.min(0.05, (now - last) / 1000);
    last = now;

    if (running) {
      acc += dt;
      const stepDt = 1 / Math.max(1, stepsPerSecond);

      // avoid spiral of death
      let steps = 0;
      while (acc >= stepDt && steps < 4) {
        step();
        acc -= stepDt;
        steps++;
      }
      draw();
    } else {
      // still redraw occasionally for crisp UI feel
      if (Math.random() < 0.04) draw();
    }

    requestAnimationFrame(loop);
  }

  window.addEventListener("resize", resize);
  resize();
  requestAnimationFrame(loop);
})();
</script>

</body>
</html>
